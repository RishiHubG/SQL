/*
for Ug: in json check InGroup=1 and extract the user id
get all AccessControlledResource ID FOR THE ENTITYid - insert/update/delete UserAccessControlledResource for each accID and userID

AccessControlledResource - get the access controlid and userid for the above ug
*/

USE ClientDemo_Dev
GO
 
SELECT TOP 1  * FROM AccessControlledResource
SELECT top 1 * FROM UserAccessControlledResource

SELECT * FROM UserAccessControlledResource

ROLLBACK
--UG
SET XACT_ABORT ON
BEGIN TRAN
exec SaveUserAccessControlledResource @EntityId=12,@UserType='UserGroup',
@InputJson=N'{"name":"Risk Managers","description":"","dataGrid":[{"entityuserpermissionid":-1,"userid":7,"isgroup":0,"ismappedforentity":0,"userName":"Auditor1","displayname":"Auditor 1  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":18,"isgroup":0,"ismappedforentity":0,"userName":"Auditor2","displayname":"Auditor 2  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":14,"isgroup":0,"ismappedforentity":0,"userName":"rmanager","displayname":"rmanager  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":19,"isgroup":0,"ismappedforentity":0,"userName":"AManager2","displayname":"AManager2  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":8,"isgroup":0,"ismappedforentity":0,"userName":"AuditManager","displayname":"Audit  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":20,"isgroup":0,"ismappedforentity":0,"userName":"FormUser","displayname":"FormUser  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":true},{"entityuserpermissionid":-1,"userid":17,"isgroup":0,"ismappedforentity":0,"userName":"Fowner","displayname":"FOnwer  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":true},{"entityuserpermissionid":-1,"userid":15,"isgroup":0,"ismappedforentity":0,"userName":"iowner","displayname":"iowner  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":16,"isgroup":0,"ismappedforentity":0,"userName":"Rcoordinator","displayname":"Rcoordinator  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":13,"isgroup":0,"ismappedforentity":0,"userName":"rowner","displayname":"Risk Owner  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":21,"isgroup":0,"ismappedforentity":0,"userName":"Tmp1","displayname":"test User  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0}],"permissionsSchemeGrid":[{"permissionschemeid":1,"Name":"Administrator Scheme","IsSelected":1},{"permissionschemeid":2,"Name":"Standard User Scheme","IsSelected":1},{"permissionschemeid":3,"Name":"New Scheme","IsSelected":0}],"administrateby":[{"entityuserpermissionid":-1,"userid":19,"isgroup":0,"ismappedforentity":0,"name":"AManager2","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":4,"isgroup":0,"ismappedforentity":0,"name":"Audit Managers","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":6,"isgroup":0,"ismappedforentity":0,"name":"Audit Module Admin","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":8,"isgroup":0,"ismappedforentity":0,"name":"AuditManager","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":7,"isgroup":0,"ismappedforentity":0,"name":"Auditor1","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":18,"isgroup":0,"ismappedforentity":0,"name":"Auditor2","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":3,"isgroup":0,"ismappedforentity":0,"name":"Auditors","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":11,"isgroup":0,"ismappedforentity":0,"name":"Finding Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":20,"isgroup":0,"ismappedforentity":0,"name":"FormUser","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":17,"isgroup":0,"ismappedforentity":0,"name":"Fowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":15,"isgroup":0,"ismappedforentity":0,"name":"iowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":5,"isgroup":0,"ismappedforentity":0,"name":"Issue Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":16,"isgroup":0,"ismappedforentity":0,"name":"Rcoordinator","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":10,"isgroup":0,"ismappedforentity":0,"name":"Risk Coordinators","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":12,"isgroup":0,"ismappedforentity":0,"name":"Risk Managers","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":9,"isgroup":0,"ismappedforentity":0,"name":"Risk Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":14,"isgroup":0,"ismappedforentity":0,"name":"rmanager","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":13,"isgroup":0,"ismappedforentity":0,"name":"rowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":21,"isgroup":0,"ismappedforentity":0,"name":"Tmp1","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""}],"permissions":{"read":0,"modify":0,"write":0,"administrate":0,"cut":0,"copy":0,"export":0,"delete":0,"report":0,"adhoc":0},"administratedescription":""}',
@MethodName=NULL,@UserLoginID=376

--UG
exec SaveEntityDetail @EntityId=12,@EntitytypeId=6,@InputJson=N'{"name":"Risk Managers","description":"","dataGrid":[{"entityuserpermissionid":-1,"userid":7,"isgroup":0,"ismappedforentity":0,"userName":"Auditor1","displayname":"Auditor 1  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":18,"isgroup":0,"ismappedforentity":0,"userName":"Auditor2","displayname":"Auditor 2  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":14,"isgroup":0,"ismappedforentity":0,"userName":"rmanager","displayname":"rmanager  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":1},{"entityuserpermissionid":-1,"userid":19,"isgroup":0,"ismappedforentity":0,"userName":"AManager2","displayname":"AManager2  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":8,"isgroup":0,"ismappedforentity":0,"userName":"AuditManager","displayname":"Audit  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":20,"isgroup":0,"ismappedforentity":0,"userName":"FormUser","displayname":"FormUser  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":true},{"entityuserpermissionid":-1,"userid":17,"isgroup":0,"ismappedforentity":0,"userName":"Fowner","displayname":"FOnwer  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":true},{"entityuserpermissionid":-1,"userid":15,"isgroup":0,"ismappedforentity":0,"userName":"iowner","displayname":"iowner  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":16,"isgroup":0,"ismappedforentity":0,"userName":"Rcoordinator","displayname":"Rcoordinator  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":13,"isgroup":0,"ismappedforentity":0,"userName":"rowner","displayname":"Risk Owner  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0},{"entityuserpermissionid":-1,"userid":21,"isgroup":0,"ismappedforentity":0,"userName":"Tmp1","displayname":"test User  ","isadmin":0,"groupid":0,"rights":0,"active":1,"inGroup":0}],"permissionsSchemeGrid":[{"permissionschemeid":1,"Name":"Administrator Scheme","IsSelected":1},{"permissionschemeid":2,"Name":"Standard User Scheme","IsSelected":1},{"permissionschemeid":3,"Name":"New Scheme","IsSelected":0}],"administrateby":[{"entityuserpermissionid":-1,"userid":19,"isgroup":0,"ismappedforentity":0,"name":"AManager2","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":4,"isgroup":0,"ismappedforentity":0,"name":"Audit Managers","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":6,"isgroup":0,"ismappedforentity":0,"name":"Audit Module Admin","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":8,"isgroup":0,"ismappedforentity":0,"name":"AuditManager","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":7,"isgroup":0,"ismappedforentity":0,"name":"Auditor1","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":18,"isgroup":0,"ismappedforentity":0,"name":"Auditor2","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":3,"isgroup":0,"ismappedforentity":0,"name":"Auditors","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":11,"isgroup":0,"ismappedforentity":0,"name":"Finding Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":20,"isgroup":0,"ismappedforentity":0,"name":"FormUser","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":17,"isgroup":0,"ismappedforentity":0,"name":"Fowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":15,"isgroup":0,"ismappedforentity":0,"name":"iowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":5,"isgroup":0,"ismappedforentity":0,"name":"Issue Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":16,"isgroup":0,"ismappedforentity":0,"name":"Rcoordinator","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":10,"isgroup":0,"ismappedforentity":0,"name":"Risk Coordinators","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":12,"isgroup":0,"ismappedforentity":0,"name":"Risk Managers","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":9,"isgroup":0,"ismappedforentity":0,"name":"Risk Owners","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"G","description":""},{"entityuserpermissionid":-1,"userid":14,"isgroup":0,"ismappedforentity":0,"name":"rmanager","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":13,"isgroup":0,"ismappedforentity":0,"name":"rowner","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""},{"entityuserpermissionid":-1,"userid":21,"isgroup":0,"ismappedforentity":0,"name":"Tmp1","displayname":null,"isadmin":0,"groupid":0,"rights":0,"active":null,"ingroup":0,"userorgroup":"U","description":""}],"permissions":{"read":0,"modify":0,"write":0,"administrate":0,"cut":0,"copy":0,"export":0,"delete":0,"report":0,"adhoc":0},"administratedescription":""}',@additionalJSONData=N'{}',@MethodName=NULL,@UserLoginID=376
--USER
exec SaveEntityDetail @EntityId=-1,@EntitytypeId=4,@InputJson=N'{"userGroups":[{"groupid":2,"groupname":"Administrators","groupdescription":"de","ingroup":false,"isadministrate":0},{"groupid":3,"groupname":"Auditors","groupdescription":"","ingroup":true,"isadministrate":0},{"groupid":4,"groupname":"Audit Managers","groupdescription":"","ingroup":true,"isadministrate":0},{"groupid":5,"groupname":"Issue Owners","groupdescription":"","ingroup":true,"isadministrate":0},{"groupid":6,"groupname":"Audit Module Admin","groupdescription":"","ingroup":false,"isadministrate":0},{"groupid":9,"groupname":"Risk Owners","groupdescription":"","ingroup":false,"isadministrate":0},{"groupid":10,"groupname":"Risk Coordinators","groupdescription":"","ingroup":false,"isadministrate":0},{"groupid":11,"groupname":"Finding Owners","groupdescription":"","ingroup":false,"isadministrate":0},{"groupid":12,"groupname":"Risk Managers","groupdescription":"","ingroup":false,"isadministrate":0}],"permissionScheme":[{"permissionschemeid":1,"name":"Administrator Scheme","isselected":0,"isinherited":0,"isadministrate":0,"permissionschemedescription":""},{"permissionschemeid":2,"name":"Standard User Scheme","isselected":true,"isinherited":0,"isadministrate":0,"permissionschemedescription":""},{"permissionschemeid":3,"name":"New Scheme","isselected":true,"isinherited":0,"isadministrate":0,"permissionschemedescription":""}],"title":"mr","firstname":"test User","middlename":"","lastname":"","fileas":"Distint Name","loginname":"Tmp1","password":"a04c0672e106990c6689def9dc3ad717","usertype":1,"jobtitle":"","email":"","phonenumberbusiness":"","phonenumberhome":"","active":true,"validupto":"2023-03-31T00:00:00+05:30","forcepasswordchangeonnextlogin":false,"locked":false,"dormant":false,"resetpassword":false,"description":"","company":""}',@additionalJSONData=N'{}',@MethodName=NULL,@UserLoginID=376